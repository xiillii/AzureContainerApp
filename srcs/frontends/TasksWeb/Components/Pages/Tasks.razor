@page "/tasks"
@rendermode InteractiveServer
@using TasksWeb.Services
@using Shared.Models
@inject TasksApiClient TasksApi
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Tasks</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Tasks</h2>
        <div>
            <button class="btn btn-primary me-2" @onclick="ShowCreateForm">
                <i class="bi bi-plus-circle"></i> New Task
            </button>
            <button class="btn btn-outline-secondary" @onclick="Logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (showForm)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">@(editingTask?.Id > 0 ? "Edit Task" : "Create Task")</h5>
                <EditForm Model="@editingTask" OnValidSubmit="@SaveTask" FormName="taskForm">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <InputText @bind-Value="editingTask!.Title" class="form-control" />
                        <ValidationMessage For="@(() => editingTask.Title)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <InputTextArea @bind-Value="editingTask.Description" class="form-control" rows="3" />
                    </div>

                    <div class="mb-3 form-check">
                        <InputCheckbox @bind-Value="editingTask.IsCompleted" class="form-check-input" id="isCompleted" />
                        <label class="form-check-label" for="isCompleted">Completed</label>
                    </div>

                    <div>
                        <button type="submit" class="btn btn-success me-2" disabled="@isLoading">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @if (isLoading && tasks == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (tasks == null || !tasks.Any())
    {
        <div class="alert alert-info">
            No tasks yet. Click "New Task" to create one!
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var task in tasks.OrderByDescending(t => t.CreatedAt))
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card @(task.IsCompleted ? "border-success" : "")">
                        <div class="card-body">
                            <h5 class="card-title">
                                @if (task.IsCompleted)
                                {
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                }
                                else
                                {
                                    <i class="bi bi-circle"></i>
                                }
                                @task.Title
                            </h5>
                            <p class="card-text text-muted">@task.Description</p>
                            <small class="text-muted">Created: @task.CreatedAt.ToString("MMM dd, yyyy")</small>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => EditTask(task)">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTask(task.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<TaskItem>? tasks;
    private TaskItem? editingTask;
    private bool showForm;
    private bool isLoading;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        tasks = await TasksApi.GetTasksAsync();
        isLoading = false;

        if (tasks == null)
        {
            errorMessage = "Failed to load tasks. Please check your connection.";
        }
    }

    private void ShowCreateForm()
    {
        editingTask = new TaskItem 
        { 
            Title = string.Empty,
            Description = string.Empty,
            IsCompleted = false,
            CreatedAt = DateTime.UtcNow
        };
        showForm = true;
    }

    private void EditTask(TaskItem task)
    {
        editingTask = new TaskItem
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            IsCompleted = task.IsCompleted,
            CreatedAt = task.CreatedAt
        };
        showForm = true;
    }

    private async Task SaveTask()
    {
        if (editingTask == null) return;

        isLoading = true;
        bool success;

        if (editingTask.Id > 0)
        {
            success = await TasksApi.UpdateTaskAsync(editingTask.Id, editingTask);
        }
        else
        {
            success = await TasksApi.CreateTaskAsync(editingTask);
        }

        isLoading = false;

        if (success)
        {
            showForm = false;
            editingTask = null;
            await LoadTasks();
        }
        else
        {
            errorMessage = "Failed to save task. Please try again.";
        }
    }

    private void CancelEdit()
    {
        showForm = false;
        editingTask = null;
    }

    private async Task DeleteTask(int id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this task?"))
            return;

        isLoading = true;
        var success = await TasksApi.DeleteTaskAsync(id);
        isLoading = false;

        if (success)
        {
            await LoadTasks();
        }
        else
        {
            errorMessage = "Failed to delete task. Please try again.";
        }
    }

    private void Logout()
    {
        AuthService.Logout();
        Navigation.NavigateTo("/login");
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;
}
